<!DOCTYPE html>
<html>
  <head>
    <title>Node.js Programming for Modern Web</title>
    <style>
      .line {
        overflow: hidden;
      }
      .seat {
        margin: 2px;
        float: left;
        width: 30px;
        height: 30px;
        border-radius: 3px;
      }
      .enable {
        background: gray;
      }
      .enable:hover {
        background: black;
      }
      .disable {
        background: red;
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io.connect("http://localhost:52273");
      socket.on("reserve", (data) => {
        const $target = $(
          "div[data-x = " + data.x + "][data-y = " + data.y + "]"
        );
        $target.removeClass("enable");
        $target.addClass("disable");
      });
    </script>
    <script>
      socket.on("cancel", (data) => {
        const $target = $(
          "div[data-x = " + data.x + "][data-y = " + data.y + "]"
        );
        $target.removeClass("disable");
        $target.addClass("enable");
      });
    </script>
    <script>
      $(document).ready(() => {
        function onClickSeat() {
          const x = $(this).attr("data-x");
          const y = $(this).attr("data-y");
          if (confirm("좌석을 예약하시겠습니까?")) {
            $(this).off("click");
            socket.emit("reserve", { x: x, y: y });
          } else {
            alert("취소되었습니다.");
          }
        }
        function onClickSeatCancel() {
          const x = $(this).attr("data-x");
          const y = $(this).attr("data-y");
          if (confirm("예약을 취소하겠습니까?")) {
            $(this).off("click");
            socket.emit("cancel", { x: x, y: y });
          }
        }
        $("#movie_selection").submit(function (event) {
          event.preventDefault();
          const movie = $("#movie_list").val();
          const movie_date = $("#movie_date_input").val();
          $.getJSON(
            `seats/?movie_data=${movie_date}&movie=${movie}`,
            { dummy: new Date().getTime() },
            function (data) {
              console.log("실행");
              $.each(data, (indexY, line) => {
                const $line = $("<div></div>").addClass("line");
                $.each(line, (indexX, seat) => {
                  var $output = $("<div></div>", {
                    class: "seat",
                    "data-x": indexX,
                    "data-y": indexY,
                  }).appendTo($line);
                  if (seat == 1) {
                    $output.addClass("enable").on("click", onClickSeat);
                  } else if (seat == 2) {
                    $output.addClass("disable").on("click", onClickSeatCancel);
                  }
                });
                $line.appendTo("body");
              });
            }
          );
        });
      });
    </script>
  </head>
  <body>
    <form action="" method="get" id="movie_selection">
      <input type="date" name="movie_date" id="movie_date_input" />
      <input type="submit" value="select_movie" id="movie_select_button" />
    </form>
    <select name="movie" id="movie_list" form="movie_selection">
      <option value="0">A 영화</option>
      <option value="1">B 영화</option>
    </select>
  </body>
</html>
